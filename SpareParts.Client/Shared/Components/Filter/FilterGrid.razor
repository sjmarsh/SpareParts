@typeparam T

@using SpareParts.Shared.Models
@using System.Text
@using Humanizer

@inject IGraphQLRequestBuilder graphQLRequestBuilder
@inject IState<SearchState> SearchState
@inject IDispatcher Dispatcher

<div>
    <div>
        @if (SearchState.Value.FilterFields != null)
        {
            <ChipsList Chips="SearchState.Value.FilterFields.Select(f => new Chip(f.Name, f.IsSelected)).ToList()" Title="Fields" OnToggleChip="HandleToggleField"/>
        }
    </div>

    <div>
        @if (SearchState.Value.FilterLines != null && SearchState.Value.FilterFields != null)
        {
            <EditForm Model="SearchState.Value.FilterLines" OnValidSubmit="HandleValidSubmit">
                 <div class="card mt-2">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Filters</h6>
                        @foreach (var filterLine in SearchState.Value.FilterLines)
                        {
                            <FilterSelector Fields="SearchState.Value.FilterFields.ToList()" Operators="_operators" FilterLine="filterLine" OnRemoveFilter="RemoveFilter" />
                        }
                        <div class="mt-2">
                            <button type="button" class="btn btn-secondary my-1" @onclick="AddEmptyFilter">Add Filter</button>
                            <button type="submit" class="btn btn-primary my-1">Search</button>
                        </div>
                    </div>
                 </div>
            </EditForm>
        }
    </div>
    @if (_hasError)
    {
        <div class="alert alert-danger py-1">
            @_errorMessage
        </div>
    }

    @if(_filterResults != null && SearchState.Value.FilterFields != null){
        <SimpleDataGrid T="T" DataSource="_filterResults" ColumnList="SearchState.Value.FilterFields.Where(f => f.IsSelected).Select(f => f.Name).ToList()" OnRowClick="OnRowClick" />
    }
        
</div>


@code
{
    [Parameter]
    public EventCallback<Dictionary<string, string>> OnRowClick { get; set; }

    [Parameter]
    public string? RootGraphQLField { get; set; }

    [Parameter]
    [EditorRequired]
    public Func<GraphQLRequest, Task<List<T>>>? ServiceCall { get; set; }

    private List<T>? _filterResults { get; set; }

    //private List<FilterField>? _filterFields;
    private List<NamedFilterOperator>? _operators;
    //private List<FilterLine>? _filterLines;
    private const int MaxFilterLineCount = 5;

    private bool _hasError;
    private string? _errorMessage;

    // TODO PAGING
    private int _totalItemCount;
    private const int PageSize = 10;


    protected override void OnInitialized()
    {
        Dispatcher.Dispatch(new InitializeFilterFieldsAction(GetFilterFields()));
        //_filterFields = GetFilterFields();
        var x = SearchState.Value.FilterFields;

        _operators = FilterOperator.NamedFilterOperators().ToList();
        //_filterLines = new List<FilterLine>();

        if (!HasFilterLines())
        {
            AddEmptyFilter();
        }
        
        _hasError = false;
        _errorMessage = string.Empty;
    }


    private List<FilterField> GetFilterFields()
    {
        var props = typeof(T).GetProperties();
        var fields = props.Select(p => new FilterField(p.Name, p.PropertyType, true)).Where(f => f.Name.ToLower() != "id");
        return fields.ToList();
    }

    private void AddEmptyFilter()
    {
        if (SearchState.Value.FilterLines != null && SearchState.Value.FilterLines.Count <= MaxFilterLineCount - 1
                && SearchState.Value.FilterFields != null)
        {
            //_filterLines?.Add(new FilterLine(_filterFields.First(), FilterOperator.Equal, ""));
            Dispatcher.Dispatch(new AddFilterLineAction(new FilterLine(SearchState.Value.FilterFields.First(), FilterOperator.Equal, "")));
        }
    }

    private async Task RemoveFilter(FilterLine filterLine)
    {
        if (HasFilterLines())
        {
            //var itemToRemove = _filterLines?.FirstOrDefault(f => f.Equals(filterLine));
            //if (itemToRemove != null)
            //{
            //    _filterLines?.Remove(itemToRemove);
            //    await Search();
            //}
            Dispatcher.Dispatch(new RemoveFilterLineAction(filterLine));
            await Search();
        }
    }

    private async Task HandleToggleField(Chip chip)
    {
        if(HasFilterFields() && SearchState.Value.FilterLines != null && chip != null)
        {
            //var itemToToggle = _filterFields.FirstOrDefault(f => f.Name == chip.Name);
            var filterAlreadyUsed = SearchState.Value.FilterLines.FirstOrDefault(f => f.SelectedField.Name == chip.Name) != null;
            if(!filterAlreadyUsed)
            {
                Dispatcher.Dispatch(new ToggleFilterFieldAction(chip.Name));
                await Search();
            }
        }
    }

    private async Task HandleValidSubmit(EditContext context)
    {
        await Search();
    }

    private async Task Search()
    {
        ClearFilterResults();
        if (HasFilterLines() && HasFilterFields())
        {
            var validator = new FilterLinesValidator();
            var filterFieldsList = SearchState.Value.FilterLines.ToList();
            var validationResult = validator.Validate(filterFieldsList);
            if (validationResult.IsValid)
            {
                var graphQLRequest = graphQLRequestBuilder.Build<T>(filterFieldsList, SearchState.Value.FilterFields.ToList());

                if(ServiceCall != null)
                {
                    var serviceResult = await ServiceCall.Invoke(graphQLRequest);

                    if (serviceResult != null && serviceResult.Any())
                    {
                        _filterResults = serviceResult;
                        _hasError = false;
                        _errorMessage = string.Empty;
                    }
                    else
                    {
                        _hasError = true;
                        _errorMessage = "No results found";
                    }
                }
            }
            else
            {
                _hasError = true;
                var sb = new StringBuilder();
                for (int i = 0; i < validationResult.Errors.Count; i++)
                {
                    var error = validationResult.Errors[i];
                    sb.AppendLine($"Row {i} is invalid. {error.ErrorMessage}");
                }
                _errorMessage = sb.ToString();
                
                return;
            }            
        }
    }

    private bool HasFilterFields()
    {
        return SearchState.Value.FilterFields != null && SearchState.Value.FilterFields.Any();
    }

    private bool HasFilterLines()
    {
        return SearchState.Value.FilterLines != null && SearchState.Value.FilterLines.Any();
    }

    private void ClearFilterResults()
    {
        _filterResults = new List<T>();
    }
}
